<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/battle-pokemon.css">
    <link rel="icon" type="image/x-icon" href="img/favIcon.png">
    <title>Batalla Pokemon</title>
</head>

<body>
    <div class="layout">
        <nav class="navbar__container">
            <div class="navbar__container-logo">
                <img class="navbar__img" src="img/logoPokemon.png" alt="logo pokemon">
            </div>
            <ul class="navbar__container-links">
                <li class="navbar__item">
                    <i class='bx bx-exit'></i><a class="navbar_link" href="login">Salir</a>
                </li>
                <li class="navbar__item">
                    <i class='bx bx-plus-medical navbar_link-icon'></i><a class="navbar_link" href="list-teams">Listado
                        de equipos</a>
                </li>
                <li class="navbar__item">
                    <i class='bx bxs-group navbar_link-icon'></i><a class="navbar_link" href="search-friends">Amigos</a>
                </li>
                <li class="navbar__item">
                    <i class='bx bxs-cog navbar_link-icon'></i><a class="navbar_link" href="settings">Ajustes</a>
                </li>
            </ul>
        </nav>
    </div>
    <div class="battle__input">
        <div class="container__trainer-1">
            <p class="trainer1__info">
                <%= nameUser %>
            </p>
            <div class="trainer1-img__container">
                <% if (imagePathUser) { %>
                    <img class="trainer-1__img" src="<%= imagePathUser %>" alt="<%= nameUser %>" id="userImg">
                    <% } else { %>
                        <p>No profile image available.</p>
                        <% } %>
            </div>
            <div class="container__pokeballs">
                <img src="img/pokeball.png" alt="Pokeball">
                <img src="img/pokeball.png" alt="Pokeball">
                <img src="img/pokeball.png" alt="Pokeball">
                <img src="img/pokeball.png" alt="Pokeball">
                <img src="img/pokeball.png" alt="Pokeball">
                <img src="img/pokeball.png" alt="Pokeball">
            </div>
        </div>
        <div class="background__battle">
            <main>
                <form>
                    <div class="fila">
                        <div class="fila">
                            <input type="text" placeholder="Nombre Equipo 1" name="teamOneName" id="teamOneName">
                            <button class="select__button" onclick="fetchTeamData('teamOneName', 'pokemon1')"
                                type="button">
                                Cargar Equipo
                            </button>
                            <label for="pokemon1">Equipos jugador 1:</label>
                            <select id="pokemon1"></select>
                        </div>
                        <div class="fila">
                            <input type="text" placeholder="Nombre Equipo 2" name="teamTwoName" id="teamTwoName">
                            <button class="select__button" onclick="fetchTeamData('teamTwoName', 'pokemon2')"
                                type="button">
                                Cargar Equipo
                            </button>
                            <label for="pokemon2">Equipos jugador 2:</label>
                            <select id="pokemon2"></select>
                        </div>
                    </div>
                    <button class="start__button" onclick="startBattle()" type="button">Iniciar Batalla</button>
                </form>
                <div class="battle__container">
                    <div>
                        <img class="imagen-pokemon1" id="imagen-pokemon1" />
                        <div id="ataques-1"></div>
                    </div>
                    <div>
                        <img class="imagen-pokemon2" id="imagen-pokemon2" />
                        <div id="ataques-2"></div>
                    </div>
                </div>
                <div class="info1">
                    <p id="nombre-pokemon1"></p>
                    <progress id="vida-pokemon1"></progress>
                    <label for="vida-pokemon1" id="label-hp1"></label>
                </div>
                <div class="info2">
                    <p id="nombre-pokemon2"></p>
                    <progress id="vida-pokemon2"></progress>
                    <label for="vida-pokemon2" id="label-hp2"></label>
                </div>
            </main>
        </div>
        <div class="container__trainer-2">
            <p class="trainer2__info">
                <%= nameFriend %>
            </p>
            <div class="trainer2-img__container">
                <% if (imagePathFriend) { %>
                    <img class="trainer-2__img" src="<%= imagePathFriend %>" alt="<%= nameFriend %>" id="userImg">
                    <% } else { %>
                        <p>No profile image available.</p>
                        <% } %>
            </div>
            <div class="container__pokeballs">
                <img src="img/pokeball.png" alt="Pokeball">
                <img src="img/pokeball.png" alt="Pokeball">
                <img src="img/pokeball.png" alt="Pokeball">
                <img src="img/pokeball.png" alt="Pokeball">
                <img src="img/pokeball.png" alt="Pokeball">
                <img src="img/pokeball.png" alt="Pokeball">
            </div>
        </div>
    </div>

    <script>
        let pokemon1, pokemon2;

        function capitalizar(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        async function fetchTeamData(teamInputId, selectId) {
            const teamName = document.getElementById(teamInputId).value;

            try {
                const response = await fetch(`/team/${teamName}`);
                const team = await response.json();

                if (!response.ok) {
                    console.error('Team not found');
                    return;
                }

                populateSelectOptions(selectId, team);
            } catch (error) {
                console.error('Error fetching team data:', error);
            }
        }

        function populateSelectOptions(selectId, team) {
            const select = document.getElementById(selectId);
            const pokemonNames = [
                team.pokemonOne,
                team.pokemonTwo,
                team.pokemonThree,
                team.pokemonFour,
                team.pokemonFive,
                team.pokemonSix
            ];

            select.innerHTML = pokemonNames.map(pokemon =>
                `<option value='https://pokeapi.co/api/v2/pokemon/${pokemon.toLowerCase()}'>${capitalizar(pokemon)}</option>`
            ).join('');
        }

        async function fetchPokemon(url) {
            try {
                const respuesta = await fetch(url);
                const datos = await respuesta.json();
                return datos;
            } catch (error) {
                console.error(error);
            }
        }

        async function startBattle() {
            const select1 = document.getElementById("pokemon1");
            const select2 = document.getElementById("pokemon2");

            const pokemonSeleccionado1 = select1.options[select1.selectedIndex].value;
            const pokemonSeleccionado2 = select2.options[select2.selectedIndex].value;

            pokemon1 = await fetchPokemon(pokemonSeleccionado1);
            pokemon1.hp = pokemon1.stats[0].base_stat;
            pokemon2 = await fetchPokemon(pokemonSeleccionado2);
            pokemon2.hp = pokemon2.stats[0].base_stat;

            document.getElementById("imagen-pokemon1").src = pokemon1.sprites.back_default;
            document.getElementById("nombre-pokemon1").textContent = capitalizar(pokemon1.name);
            const hpPokemon1 = document.getElementById("vida-pokemon1");
            hpPokemon1.value = pokemon1.hp;
            hpPokemon1.max = pokemon1.stats[0].base_stat;
            document.getElementById("label-hp1").textContent = `${pokemon1.hp}/${pokemon1.stats[0].base_stat}`;

            document.getElementById("imagen-pokemon2").src = pokemon2.sprites.front_default;
            document.getElementById("nombre-pokemon2").textContent = capitalizar(pokemon2.name);
            const hpPokemon2 = document.getElementById("vida-pokemon2");
            hpPokemon2.value = pokemon2.hp;
            hpPokemon2.max = pokemon2.stats[0].base_stat;
            document.getElementById("label-hp2").textContent = `${pokemon2.hp}/${pokemon2.stats[0].base_stat}`;

            displayAttacks("ataques-1", pokemon1);
            displayAttacks("ataques-2", pokemon2);
        }

        function displayAttacks(containerId, pokemon) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            pokemon.moves.slice(0, 4).forEach(move => {
                const button = document.createElement('button');
                button.textContent = move.move.name;
                button.onclick = () => attackOpponent(move.move.name, pokemon);
                container.appendChild(button);
            });
        }

        function attackOpponent(moveName, attacker) {
            const damage = Math.floor(Math.random() * 10) + 5; // Random damage between 5 and 15

            if (attacker.name === pokemon1.name) {
                pokemon2.hp -= damage;
                if (pokemon2.hp < 0) pokemon2.hp = 0;
                updateHP("vida-pokemon2", "label-hp2", pokemon2);
            } else {
                pokemon1.hp -= damage;
                if (pokemon1.hp < 0) pokemon1.hp = 0;
                updateHP("vida-pokemon1", "label-hp1", pokemon1);
            }
        }

        function updateHP(progressId, labelId, pokemon) {
            const progressBar = document.getElementById(progressId);
            progressBar.value = pokemon.hp;
            document.getElementById(labelId).textContent = `${pokemon.hp}/${progressBar.max}`;
        }
    </script>
</body>

</html>