<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/battle-pokemon.css">
    <link rel="icon" type="image/x-icon" href="img/favIcon.png">
    <title>Batalla Pokemon</title>
</head>

<body>
    <div class="layout">
        <nav class="navbar__container">
            <div class="navbar__container-logo">
                <img class="navbar__img" src="img/logoPokemon.png" alt="logo pokemon">
            </div>
            <ul class="navbar__container-links">
                <li class="navbar__item">
                    <i class='bx bx-exit'></i><a class="navbar_link" href="login">Salir</a>
                </li>
                <li class="navbar__item">
                    <i class='bx bx-plus-medical navbar_link-icon'></i><a class="navbar_link" href="list-teams">Listado
                        de equipos</a>
                </li>
                <li class="navbar__item">
                    <i class='bx bxs-group navbar_link-icon'></i><a class="navbar_link" href="search-friends">Amigos</a>
                </li>
                <li class="navbar__item">
                    <i class='bx bxs-cog navbar_link-icon'></i><a class="navbar_link" href="settings">Ajustes</a>
                </li>
            </ul>
        </nav>
    </div>
    <div class="battle__input">
        <div class="container__trainer-1">
            <p class="trainer1__info">
                <%= nameUser %>
            </p>
            <div class="trainer1-img__container">
                <% if (imagePathUser) { %>
                    <img class="trainer-1__img" src="<%= imagePathUser %>" alt="<%= nameUser %>" id="userImg">
                    <% } else { %>
                        <p>No profile image available.</p>
                        <% } %>
            </div>
            <div class="container__pokeballs">
                <img src="img/pokeball.png" alt="Pokeball">
                <img src="img/pokeball.png" alt="Pokeball">
                <img src="img/pokeball.png" alt="Pokeball">
                <img src="img/pokeball.png" alt="Pokeball">
                <img src="img/pokeball.png" alt="Pokeball">
                <img src="img/pokeball.png" alt="Pokeball">
            </div>
        </div>
        <div class="background__battle">
            <main>
                <form>
                    <div class="fila">
                        <div class="fila">
                            <label for="pokemon1">Equipos jugador 1:</label>
                            <select id="pokemon1"></select>
                        </div>
                        <div>
                            <button class="select__buttom" onclick="cargarPokemones()" id="boton2" type="button">
                                Iniciar Batalla
                            </button>
                        </div>
                        <div class="fila">
                            <label for="pokemon2">Equipos jugador 2:</label>
                            <select id="pokemon2"></select>
                        </div>
                    </div>
                </form>
                <div class="battle__container">
                    <div>
                        <img class="imagen-pokemon1" id="imagen-pokemon1" />
                    </div>
                    <div id="ataques-1"></div>
                    <div>
                        <img class="imagen-pokemon2" id="imagen-pokemon2" />
                    </div>
                    <div id="ataques-2"></div>
                </div>
                <div class="info1">
                    <p id="nombre-pokemon1"></p>
                    <progress id="vida-pokemon1"></progress>
                    <label for="vida-pokemon1" id="label-hp1"></label>
                </div>
                <div class="info2">
                    <p id="nombre-pokemon2"></p>
                    <progress id="vida-pokemon2"></progress>
                    <label for="vida-pokemon2" id="label-hp2"></label>
                </div>
            </main>
        </div>
        <div class="container__trainer-2">
            <p class="trainer2__info">
                <%= nameFriend %>
            </p>
            <div class="trainer2-img__container">
                <% if (imagePathFriend) { %>
                    <img class="trainer-2__img" src="<%= imagePathFriend %>" alt="<%= nameFriend %>" id="userImg">
                    <% } else { %>
                        <p>No profile image available.</p>
                        <% } %>
            </div>
            <div class="container__pokeballs">
                <img src="img/pokeball.png" alt="Pokeball">
                <img src="img/pokeball.png" alt="Pokeball">
                <img src="img/pokeball.png" alt="Pokeball">
                <img src="img/pokeball.png" alt="Pokeball">
                <img src="img/pokeball.png" alt="Pokeball">
                <img src="img/pokeball.png" alt="Pokeball">
            </div>
        </div>
    </div>

    <script>
        let userPokemons;
        let pokemon1, pokemon2;

        function capitalizar(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // Use the userPokemons variable from the backend
        window.onload = function () {
            userPokemons = JSON.parse('<%- userPokemons %>');
            populateSelectOptions();
        };

        function populateSelectOptions() {
            const select1 = document.getElementById("pokemon1");
            const select2 = document.getElementById("pokemon2");

            select1.innerHTML = userPokemons[0].pokemons.map(pokemon =>
                `<option value='${pokemon.url}'>${capitalizar(pokemon.name)}</option>`
            ).join('');

            select2.innerHTML = userPokemons[0].pokemons.map(pokemon =>
                `<option value='${pokemon.url}'>${capitalizar(pokemon.name)}</option>`
            ).join('');
        }

        async function fetchPokemon(url) {
            try {
                const respuesta = await fetch(url);
                const datos = await respuesta.json();
                return datos;
            } catch (error) {
                console.error(error);
            }
        }

        const cargarPokemones = async () => {
            const select1 = document.getElementById("pokemon1");
            const select2 = document.getElementById("pokemon2");

            const pokemonSeleccionado1 = select1.options[select1.selectedIndex].value;
            const pokemonSeleccionado2 = select2.options[select2.selectedIndex].value;

            pokemon1 = await fetchPokemon(pokemonSeleccionado1);
            pokemon1.hp = pokemon1.stats[0].base_stat;
            pokemon2 = await fetchPokemon(pokemonSeleccionado2);
            pokemon2.hp = pokemon2.stats[0].base_stat;

            // Update Pokémon 1 details
            document.getElementById("imagen-pokemon1").src = pokemon1.sprites.back_default;
            document.getElementById("nombre-pokemon1").textContent = capitalizar(pokemon1.name);
            const hpPokemon1 = document.getElementById("vida-pokemon1");
            hpPokemon1.value = pokemon1.hp;
            hpPokemon1.max = pokemon1.stats[0].base_stat;
            document.getElementById("label-hp1").textContent = `${pokemon1.hp}/${pokemon1.stats[0].base_stat}`;

            // Update Pokémon 2 details
            document.getElementById("imagen-pokemon2").src = pokemon2.sprites.front_default;
            document.getElementById("nombre-pokemon2").textContent = capitalizar(pokemon2.name);
            const hpPokemon2 = document.getElementById("vida-pokemon2");
            hpPokemon2.value = pokemon2.hp;
            hpPokemon2.max = pokemon2.stats[0].base_stat;
            document.getElementById("label-hp2").textContent = `${pokemon2.hp}/${pokemon2.stats[0].base_stat}`;

            // Generate attacks for selected Pokémon
            const ataquesContenedor1 = document.getElementById("ataques-1");
            const ataquesContenedor2 = document.getElementById("ataques-2");

            await generarAtaques(pokemon1, ataquesContenedor1, 'pokemon2');
            await generarAtaques(pokemon2, ataquesContenedor2, 'pokemon1');
        };

        const generarAtaques = async (pokemon, contenedor, opponentPokemon) => {
            const movesPokemon = [];
            for (let i = 0; i < 4; i++) {
                const indice = Math.floor(Math.random() * pokemon.moves.length);
                movesPokemon.push(pokemon.moves[indice]);
            }

            const promesas = movesPokemon.map(ataque => fetch(ataque.move.url));
            const respuestas = await Promise.all(promesas);
            const ataques = await Promise.all(respuestas.map(respuesta => respuesta.json()));

            contenedor.innerHTML = ataques.map(
                ataque => `<button class="boton-ataque" onclick="aplicarDano(${ataque.power}, '${opponentPokemon}')">${capitalizar(ataque.name)}</button>`
            ).join('');
        };

        function aplicarDano(dano, pokemon) {
            const pokemonObj = pokemon === 'pokemon1' ? pokemon1 : pokemon2;
            pokemonObj.hp -= dano;
            if (pokemonObj.hp < 0) pokemonObj.hp = 0;

            // Update health display
            const hpElement = pokemon === 'pokemon1' ? document.getElementById("vida-pokemon1") : document.getElementById("vida-pokemon2");
            const labelHpElement = pokemon === 'pokemon1' ? document.getElementById("label-hp1") : document.getElementById("label-hp2");

            hpElement.value = pokemonObj.hp;
            labelHpElement.textContent = `${pokemonObj.hp}/${pokemonObj.stats[0].base_stat}`;

            // Add damage effect
            const imageElement = pokemon === 'pokemon1' ? document.getElementById("imagen-pokemon1") : document.getElementById("imagen-pokemon2");
            imageElement.classList.add("dano");
            setTimeout(() => {
                imageElement.classList.remove("dano");
                if (pokemonObj.hp === 0) {
                    imageElement.classList.add("muerto");
                }
            }, 501);
        }

    </script>
</body>

</html>